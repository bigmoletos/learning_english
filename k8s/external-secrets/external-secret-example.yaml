apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: app-secrets
  namespace: default
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: infisical-secretstore
    kind: SecretStore

  # Project ID dans Infisical
  target:
    name: app-secrets
    creationPolicy: Owner
    type: Opaque

  # Mapping des secrets depuis Infisical vers Kubernetes Secret
  data:
    # Base de donn√©es
    - secretKey: POSTGRES_PASSWORD
      remoteRef:
        key: POSTGRES_PASSWORD
        projectId: "your-project-id"
        environment: "production"

    - secretKey: POSTGRES_USER
      remoteRef:
        key: POSTGRES_USER
        projectId: "your-project-id"
        environment: "production"

    - secretKey: POSTGRES_HOST
      remoteRef:
        key: POSTGRES_HOST
        projectId: "your-project-id"
        environment: "production"

    # JWT
    - secretKey: JWT_SECRET
      remoteRef:
        key: JWT_SECRET
        projectId: "your-project-id"
        environment: "production"

    # SMTP
    - secretKey: SMTP_PASSWORD
      remoteRef:
        key: SMTP_PASSWORD
        projectId: "your-project-id"
        environment: "production"

    - secretKey: SMTP_USERNAME
      remoteRef:
        key: SMTP_USERNAME
        projectId: "your-project-id"
        environment: "production"

    # Firebase
    - secretKey: FIREBASE_PRIVATE_KEY
      remoteRef:
        key: FIREBASE_PRIVATE_KEY
        projectId: "your-project-id"
        environment: "production"

    - secretKey: FIREBASE_PROJECT_ID
      remoteRef:
        key: FIREBASE_PROJECT_ID
        projectId: "your-project-id"
        environment: "production"

---
# Exemple d'utilisation dans un Pod
apiVersion: v1
kind: Pod
metadata:
  name: app-example
  namespace: default
spec:
  containers:
    - name: app
      image: your-app:latest
      env:
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: POSTGRES_PASSWORD
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: JWT_SECRET
        # ... autres variables d'environnement

